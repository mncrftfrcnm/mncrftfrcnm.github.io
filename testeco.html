<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EcoRay Grove ‚Äî Nature Scroll</title>
  <meta name="description" content="A whimsical, nature-themed website powered by Three.js. Plants grow as you scroll. Inspired by painterly platformer vibes." />
  <link rel="preconnect" href="https://unpkg.com" />
  <link rel="preconnect" href="https://threejs.org" />
  <link href="https://fonts.googleapis.com/css2?family=Londrina+Solid:wght@300;400&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet" />
  <style>
    :root {
      --ink: #052d23;
      --leaf: #2fbf71;
      --leaf-2: #00a86b;
      --moss: #0f4d3f;
      --bg-1: #051a14;
      --bg-2: #0b2e24;
      --glow: #a8ffce;
      --bloom: rgba(168, 255, 206, 0.12);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      color: #eafff3;
      background: radial-gradient(1200px 800px at 20% 10%, var(--bg-2), transparent 60%),
                  radial-gradient(1400px 900px at 80% 0%, #0a392e, transparent 50%),
                  linear-gradient(180deg, var(--bg-1), #03110d 70%);
      font-family: 'Nunito', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      overflow-x: hidden;
    }
    /* 2D flora sway */
    @keyframes sway { 
    0% { transform: translateZ(0) rotateZ(-2deg); } 
    50% { transform: translateZ(0) rotateZ(2deg); } 
    100% { transform: translateZ(0) rotateZ(-2deg); } 
    }
    #floraLayer use.leaf { transform-origin: 50% 100%; animation: sway 5s ease-in-out infinite; }
    #floraLayer g.vine { animation: sway 9s ease-in-out infinite; }

    header {
      position: fixed; inset: 0 0 auto 0; z-index: 10;
      display: flex; align-items: center; justify-content: space-between;
      padding: .8rem 1.1rem; mix-blend-mode: screen;
      background: linear-gradient(180deg, rgba(6,29,23,.7), rgba(6,29,23,0));
      backdrop-filter: blur(4px);
      border-bottom: 1px solid rgba(168,255,206,.1);
    }
    .brand { display: flex; gap: .65rem; align-items: center; font-weight: 900; letter-spacing: .5px; }
    .brand .logo { width: 36px; height: 36px; border-radius: 12px; background: radial-gradient(circle at 30% 30%, var(--glow), transparent 60%), linear-gradient(135deg, var(--leaf), var(--leaf-2)); box-shadow: 0 0 24px var(--bloom), inset 0 0 10px rgba(255,255,255,.15); }
    nav a { color: #dff8ec; text-decoration: none; margin-left: 1rem; font-weight: 700; }
    nav a:hover { text-shadow: 0 0 10px var(--glow); }

    /* canvas holder */
    #stage { position: relative; height: 100svh; width: 100vw; }
    #heroCanvas { position: absolute; inset: 0; display:block; width:100%; height:100%; }
    .title-wrap {
      position: absolute; inset: auto 0 8vh 0; z-index: 5; text-align: center; pointer-events: none;
      font-family: 'Londrina Solid', cursive;
      text-shadow: 0 6px 24px rgba(0,0,0,.45), 0 0 24px var(--bloom);
    }
    h1 { font-size: clamp(44px, 7vw, 96px); margin: 0; line-height: .9; letter-spacing: .5px; }
    .subtitle { margin-top: .25rem; opacity: .9; }

    /* layered parallax leaves (pure CSS) */
    .layer { position: absolute; inset: 0; pointer-events: none; filter: drop-shadow(0 10px 20px rgba(0,0,0,.45)); }
    .leaf { position: absolute; width: max(12vw, 120px); aspect-ratio: 1/1; border-radius: 60% 40% 60% 40% / 50% 60% 40% 50%;
            background: radial-gradient(40% 40% at 30% 30%, #d7ffe8, transparent 70%), linear-gradient(135deg, #0aa96b, #067a58); opacity: .18; transform: rotate(12deg); }
    .leaf.l1 { left: -4vw; top: 8vh; transform: rotate(22deg) scale(1.2); }
    .leaf.l2 { right: -8vw; top: 18vh; transform: rotate(-14deg) scale(1.0); }
    .leaf.l3 { left: 10vw; bottom: -6vh; transform: rotate(42deg) scale(1.6); }

    /* Sections */
    section { position: relative; padding: 16vh 8vw; min-height: 110svh; display: grid; place-items: center; }
    section .card { max-width: 900px; background: linear-gradient(180deg, rgba(11,53,41,.7), rgba(5,28,22,.7)); border: 1px solid rgba(168,255,206,.12); border-radius: 24px; padding: clamp(18px, 4vw, 48px); box-shadow: 0 20px 60px rgba(0,0,0,.25), inset 0 0 80px rgba(168,255,206,.04); }
    .chip { display: inline-flex; align-items: center; gap: .5rem; padding: .3rem .65rem; border-radius: 999px; background: rgba(0,168,107,.15); border: 1px solid rgba(168,255,206,.18); font-weight: 800; letter-spacing: .4px; }
    .cta { display: inline-flex; align-items: center; gap: .6rem; padding: .9rem 1.2rem; border-radius: 999px; border: 2px solid transparent; font-weight: 900; text-decoration: none; color:#03261f; background: linear-gradient(135deg, var(--leaf), var(--leaf-2)); box-shadow: 0 10px 40px rgba(0,255,170,.25); }
    .cta:hover { filter: brightness(1.05); box-shadow: 0 16px 46px rgba(0,255,170,.35); }

    /* --- INTERACTIVE TOON GALLERY --- */
    #gallery { padding: 8vh 0; min-height: 120svh; }
    .gal-wrap {
      width: 100%;
      display: grid;
      grid-template-columns: repeat(2, minmax(300px, 1fr));
      gap: clamp(16px, 3vw, 32px);
      align-items: stretch;
      padding: 0 6vw;
    }
    @media (max-width: 900px){
      .gal-wrap { grid-template-columns: 1fr; }
    }
    .toon-card {
      position: relative;
      aspect-ratio: 4/3;
      border-radius: 28px;
      overflow: hidden;
      border: 1px solid rgba(168,255,206,.18);
      background: linear-gradient(180deg, rgba(6,33,26,.6), rgba(3,17,13,.8));
      box-shadow: 0 30px 80px rgba(0,0,0,.35), inset 0 0 120px rgba(168,255,206,.05);
      transform-style: preserve-3d;
      transition: box-shadow .3s ease, filter .3s ease;
      cursor: pointer;
      will-change: transform, filter;
    }
    .toon-card::after{
      content: ""; position: absolute; inset: -20% -20% auto -20%; height: 60%;
      background: radial-gradient(50% 50% at 30% 50%, rgba(168,255,206,.18), transparent 60%);
      mix-blend-mode: screen; transform: translateZ(40px);
      pointer-events: none;
    }
    .toon-img{
      position: absolute; inset: 0;
      width: 100%; height: 100%; object-fit: cover;
      filter: url(#toonify);
      transform: translateZ(20px) scale(1.02);
      transition: transform .5s cubic-bezier(.2,.8,.2,1), filter .35s ease;
    }
    .ink-outline{
      position: absolute; inset: 0; pointer-events: none;
      background: radial-gradient(120% 120% at 50% 110%, rgba(0,0,0,.0), rgba(0,0,0,.35));
      mix-blend-mode: multiply; opacity:.5; transform: translateZ(30px);
    }
    .toon-badge{
      position: absolute; left: 16px; top: 16px; z-index: 3;
      display:inline-flex; align-items:center; gap:.5rem;
      padding:.45rem .7rem; font-weight:900; letter-spacing:.4px;
      border-radius:999px; background: rgba(0,168,107,.22);
      border:1px solid rgba(168,255,206,.3);
      text-shadow: 0 0 10px rgba(0,0,0,.6);
      transform: translateZ(50px);
    }
    .toon-card:is(:hover, :focus-visible){
      box-shadow: 0 40px 120px rgba(0,255,170,.22);
    }
    .toon-card:is(:hover, :focus-visible) .toon-img{
      transform: translateZ(26px) scale(1.06) rotateZ(.2deg);
      filter: url(#toonify-strong) saturate(1.1);
    }
    .caption{
      position: absolute; right: 16px; bottom: 14px; z-index: 3;
      font-weight: 800; opacity: .92; transform: translateZ(50px);
      text-shadow: 0 2px 10px rgba(0,0,0,.6);
      background: rgba(3,25,20,.45);
      backdrop-filter: blur(4px);
      border: 1px solid rgba(168,255,206,.25);
      border-radius: 12px; padding: .35rem .6rem;
    }

    footer { padding: 6rem 8vw; text-align: center; color: #c8f7e6; opacity: .9; }
    .fine { font-size: .85rem; opacity: .8; }

    /* Small helpers */
    .hidden { display:none; }
  </style>

  <!-- SVG toon filter defs (posterize + edge ink) -->
  <svg width="0" height="0" style="position:absolute">
    <filter id="toonify">
      <!-- mild posterize -->
      <feComponentTransfer color-interpolation-filters="sRGB">
        <feFuncR type="discrete" tableValues="0 0.23 0.46 0.69 1"/>
        <feFuncG type="discrete" tableValues="0 0.28 0.56 0.74 1"/>
        <feFuncB type="discrete" tableValues="0 0.25 0.5  0.75 1"/>
      </feComponentTransfer>
      <!-- edge detect -->
      <feConvolveMatrix order="3" kernelMatrix="
          -1 -1 -1
          -1  8 -1
          -1 -1 -1" result="edges"/>
      <feColorMatrix in="edges" type="matrix"
        values="0 0 0 0 0
                0 0 0 0 0
                0 0 0 0 0
                0 0 0 1 0" />
      <feBlend mode="multiply" in2="SourceGraphic"/>
      <feComponentTransfer>
        <feFuncA type="table" tableValues="0 .9"/>
      </feComponentTransfer>
    </filter>

    <filter id="toonify-strong">
      <feComponentTransfer color-interpolation-filters="sRGB">
        <feFuncR type="discrete" tableValues="0 0.18 0.36 0.54 0.72 0.9 1"/>
        <feFuncG type="discrete" tableValues="0 0.2  0.4  0.6  0.8  0.9 1"/>
        <feFuncB type="discrete" tableValues="0 0.18 0.36 0.54 0.72 0.9 1"/>
      </feComponentTransfer>
      <feConvolveMatrix order="3" kernelMatrix="
          -1 -1 -1
          -1  9 -1
          -1 -1 -1" result="edgesStrong"/>
      <feBlend mode="multiply" in="edgesStrong" in2="SourceGraphic"/>
      <feColorMatrix type="saturate" values="1.25"/>
      <feComponentTransfer>
        <feFuncA type="table" tableValues="0 1"/>
      </feComponentTransfer>
    </filter>
  </svg>

  <!-- Import map for three.js -->
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
  </script>
</head>
<body>
  <header>
    <div class="brand"><div class="logo" aria-hidden="true"></div> EcoRay Grove</div>
    <nav>
      <a href="#mission">Mission</a>
      <a href="#projects">Projects</a>
      <a href="#gallery">Gallery</a>
      <a href="#join">Join</a>
    </nav>
  </header>

  <div id="stage" aria-label="Interactive nature scene">
    <canvas id="heroCanvas"></canvas>
    <div class="layer">
      <div class="leaf l1"></div>
      <div class="leaf l2"></div>
      <div class="leaf l3"></div>
    </div>
    <div class="title-wrap">
      <h1>Grow with every scroll</h1>
      <div class="subtitle">A playful eco site ‚Äî plants sprout as you explore</div>
    </div>
  </div>

  <section id="mission">
    <div class="card">
      <span class="chip">üåø Our Mission</span>
      <h2>Rewild cities, one pocket forest at a time</h2>
      <p>
        We plant micro-habitats, restore soil, and bring back pollinators. This demo shows a living identity system: the deeper you scroll, the lusher the world becomes.
      </p>
      <p>
        Tech: Three.js + GLTF models, HDR lighting, bloom, particle fireflies, procedural vines. All effects respond to scroll depth.
      </p>
      <a class="cta" href="#join">Get involved</a>
    </div>
  </section>

  <section id="projects">
    <div class="card">
      <span class="chip">ü™¥ Projects</span>
      <h2>From rooftop meadows to schoolyard jungles</h2>
      <p>Each project card could hook into CMS data. The scene reflects progress bars ‚Äî more growth when milestones are met.</p>
    </div>
  </section>

  <!-- NEW: Full-bleed, two-image interactive toon gallery -->
  <section id="gallery" aria-label="Interactive toon gallery">
    <div class="gal-wrap">
      <!-- Image 1 -->
      <figure class="toon-card" tabindex="0" data-tilt data-depth="18">
        <span class="toon-badge">üê∏ Neon Grove</span>
        <img
          class="toon-img"
          alt="Blue poison dart frog crouched on moss"
          src="https://upload.wikimedia.org/wikipedia/commons/1/17/Dendrobates_azureus_blue_poison_dart_frog.jpg"
          loading="lazy" />
        <i class="ink-outline" aria-hidden="true"></i>
        <figcaption class="caption">Blue Dart Frog ‚Äî CC BY-SA</figcaption>
      </figure>

      <!-- Image 2 -->
      <figure class="toon-card" tabindex="0" data-tilt data-depth="14">
        <span class="toon-badge">üåÄ Fractal Sprout</span>
        <img
          class="toon-img"
          alt="Close-up of romanesco broccoli showing fractal spirals"
          src="https://upload.wikimedia.org/wikipedia/commons/7/7c/Fractal_Broccoli.jpg"
          loading="lazy" />
        <i class="ink-outline" aria-hidden="true"></i>
        <figcaption class="caption">Romanesco ‚Äî CC BY-SA</figcaption>
      </figure>
    </div>
  </section>

  <section id="join">
    <div class="card">
      <span class="chip">‚ú® Join</span>
      <h2>Volunteer, donate, or partner</h2>
      <p>Buttons here could connect to forms, a shop, or a donation flow. Animations react to your actions with subtle nature-fx.</p>
      <div style="display:flex; gap:1rem; flex-wrap: wrap; margin-top: 1rem;">
        <a class="cta" href="#">Volunteer</a>
        <a class="cta" href="#">Donate</a>
        <a class="cta" href="#">Partner</a>
      </div>
    </div>
  </section>

  <footer>
    <div class="fine">
      Models hot-linked from public Three.js example assets for demo purposes. For production, self-host assets to avoid CORS/rate limits.
      <br/>Images: ‚ÄúBlue poison dart frog‚Äù &amp; ‚ÄúRomanesco‚Äù via Wikimedia Commons (CC BY-SA). Consider self-hosting and adding explicit credits/licenses.
      <br/>¬© You / CC0 assets credits inline in code.
    </div>
  </footer>

  <script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

    // ---------- setup ----------
    const canvas = document.getElementById('heroCanvas');
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true, powerPreference: 'high-performance' });
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    renderer.setSize(innerWidth, innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;

    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x08241c, 0.035);

    const camera = new THREE.PerspectiveCamera(50, innerWidth/innerHeight, 0.1, 200);
    camera.position.set(0, 2.2, 7.5);

    // Lights
    const hemi = new THREE.HemisphereLight(0x9bdcbf, 0x06100c, 0.6); scene.add(hemi);
    const sun = new THREE.DirectionalLight(0xcffff1, 1.35); sun.position.set(4, 8, 6);
    sun.castShadow = true; sun.shadow.mapSize.set(2048,2048); sun.shadow.camera.near = 1; sun.shadow.camera.far = 30; scene.add(sun);

    // Ground (soft dunes)
    const groundGeo = new THREE.PlaneGeometry(60, 60, 120, 120);
    groundGeo.rotateX(-Math.PI/2);
    const v = groundGeo.attributes.position;
    for (let i=0; i<v.count; i++){
      const x=v.getX(i), z=v.getZ(i);
      const h = Math.sin(x*0.25)*0.1 + Math.cos(z*0.22)*0.12 + Math.sin((x+z)*0.15)*0.07;
      v.setY(i, h);
    }
    groundGeo.computeVertexNormals();
    const groundMat = new THREE.MeshStandardMaterial({ color: 0x0b3a2d, roughness: 1, metalness: 0, envMapIntensity: 0.1 });
    const ground = new THREE.Mesh(groundGeo, groundMat); ground.receiveShadow = true; scene.add(ground);

    // HDRI environment
    const pmrem = new THREE.PMREMGenerator(renderer);
pmrem.compileEquirectangularShader();

// Use HalfFloat (fast, widely supported). FloatType also works.
new RGBELoader()
  .setDataType(THREE.HalfFloatType)
  .load(
    'https://threejs.org/examples/textures/equirectangular/royal_esplanade_1k.hdr',
    (hdr) => {
      const envMap = pmrem.fromEquirectangular(hdr).texture;
      scene.environment = envMap;
      hdr.dispose();
      pmrem.dispose();
    },
    undefined,
    (err) => {
      console.warn('HDR load failed, falling back to LDR env.', err);
      // Minimal, safe fallback so your materials aren‚Äôt black:
      const tex = new THREE.TextureLoader().load(
        'https://threejs.org/examples/textures/equirectangular/venice_sunset_1k.hdr.jpg'
      );
      tex.mapping = THREE.EquirectangularReflectionMapping;
      scene.environment = tex;
    }
  );

    // Post-processing
    const composer = new EffectComposer(renderer);
    const renderPass = new RenderPass(scene, camera); composer.addPass(renderPass);
    const bloom = new UnrealBloomPass(new THREE.Vector2(innerWidth, innerHeight), 0.7, 0.45, 0.85);
    composer.addPass(bloom);

    // ---------- Procedural plants (grow on scroll) ----------
    const plants = [];

    function makeLeaf(color=0x18c28f){
      const geo = new THREE.PlaneGeometry(0.35, 0.9, 1, 8);
      const pos = geo.attributes.position;
      for(let i=0;i<pos.count;i++){
        const y = pos.getY(i);
        pos.setZ(i, Math.sin((y+0.5)*2.4)*0.12);
      }
      geo.computeVertexNormals();
      const mat = new THREE.MeshStandardMaterial({ color, side: THREE.DoubleSide, roughness: .6, metalness: .0, transparent:true, opacity: .95 });
      const leaf = new THREE.Mesh(geo, mat);
      leaf.castShadow = true; return leaf;
    }

    function makeStem(height=1.8, radius=0.06, color=0x0fa06f){
      const curve = new THREE.CatmullRomCurve3([
        new THREE.Vector3(0, 0, 0),
        new THREE.Vector3(Math.sin(Math.random()*Math.PI)*0.2, height*0.33, Math.cos(Math.random()*Math.PI)*0.2),
        new THREE.Vector3(Math.sin(Math.random()*Math.PI)*0.3, height*0.66, Math.cos(Math.random()*Math.PI)*0.3),
        new THREE.Vector3(0, height, 0),
      ]);
      const geo = new THREE.TubeGeometry(curve, 40, radius, 8, false);
      const mat = new THREE.MeshStandardMaterial({ color, roughness: .9, metalness: .0 });
      const stem = new THREE.Mesh(geo, mat); stem.castShadow = true;
      return { stem, curve };
    }

    function createPlant(){
      const g = new THREE.Group();
      const h = THREE.MathUtils.randFloat(1.2, 2.4);
      const { stem, curve } = makeStem(h, THREE.MathUtils.randFloat(0.04,0.08));
      g.add(stem);
      const leafCount = THREE.MathUtils.randInt(6, 12);
      for(let i=0;i<leafCount;i++){
        const t = (i+1)/(leafCount+1);
        const p = curve.getPointAt(t);
        const n = curve.getTangentAt(t);
        const leaf = makeLeaf(0x1fe19b);
        leaf.position.copy(p);
        const axis = new THREE.Vector3(0,1,0).cross(n).normalize();
        leaf.quaternion.setFromAxisAngle(axis, Math.PI/2);
        leaf.rotateY((Math.PI*2 * i/leafCount) + Math.random()*0.5);
        const s = THREE.MathUtils.randFloat(0.7,1.2); leaf.scale.set(s,s,s);
        g.add(leaf);
      }
      g.userData = { maxH: h, growth: 0 };
      g.position.set(THREE.MathUtils.randFloatSpread(10), 0, THREE.MathUtils.randFloatSpread(10));
      return g;
    }

    for(let i=0;i<18;i++){ const p = createPlant(); plants.push(p); scene.add(p); }

    function setPlantGrowth(plant, g){
      const growth = THREE.MathUtils.clamp(g, 0, 1);
      plant.scale.y = 0.001 + growth;
      plant.children.forEach(ch => { if(ch.material && 'opacity' in ch.material){ ch.material.opacity = 0.4 + growth*0.6; }});
    }

    // ---------- Fireflies ----------
    const fireflyCount = 300;
    const flyGeo = new THREE.BufferGeometry();
    const positions = new Float32Array(fireflyCount*3);
    const speeds = new Float32Array(fireflyCount);
    for(let i=0;i<fireflyCount;i++){
      positions[i*3+0] = THREE.MathUtils.randFloatSpread(16);
      positions[i*3+1] = Math.random()*6 + 0.5;
      positions[i*3+2] = THREE.MathUtils.randFloatSpread(16);
      speeds[i] = 0.1 + Math.random()*0.4;
    }
    flyGeo.setAttribute('position', new THREE.BufferAttribute(positions,3));
    flyGeo.setAttribute('aSpeed', new THREE.BufferAttribute(speeds,1));
    const flyMat = new THREE.PointsMaterial({
      size: 0.06,
      map: new THREE.TextureLoader().load('https://threejs.org/examples/textures/sprites/spark1.png'),
      transparent: true,
      depthWrite: false,
      blending: THREE.AdditiveBlending,
      color: 0xaaffdd
    });
    const fireflies = new THREE.Points(flyGeo, flyMat); scene.add(fireflies);

    // ---------- Load external GLB birds ----------
    const loader = new GLTFLoader(); loader.setCrossOrigin('anonymous');
    const mixers = [];
    function loadBird(url, scale=1, pos=[0,1,0]){
      loader.load(url, (gltf)=>{
        const root = gltf.scene; root.traverse(o=>{ if(o.isMesh){ o.castShadow = true; o.receiveShadow = true; }});
        root.scale.setScalar(scale);
        root.position.set(...pos);
        scene.add(root);
        if(gltf.animations && gltf.animations.length){
          const mixer = new THREE.AnimationMixer(root);
          gltf.animations.forEach(clip=> mixer.clipAction(clip).play());
          mixers.push(mixer);
        }
      });
    }
    loadBird('https://threejs.org/examples/models/gltf/Parrot.glb', 0.03, [-2.2, 2.0, -1.5]);
    loadBird('https://threejs.org/examples/models/gltf/Flamingo.glb', 0.03, [ 2.6, 2.4,  0.8]);
    loadBird('https://threejs.org/examples/models/gltf/Stork.glb', 0.03, [ 0.0, 3.1, -2.2]);

    // ---------- Edge-anchored plants that grow with scroll ----------
    const edgeRig = new THREE.Group();
    camera.add(edgeRig);
    scene.add(camera);

    function createEdgePlant(){
      const g = createPlant();
      g.traverse(o=>{ if(o.material){ o.material.emissive = new THREE.Color(0x0b4032); o.material.emissiveIntensity = 0.25; }});
      return g;
    }

    const leftEdge = createEdgePlant();
    const rightEdge = createEdgePlant();
    edgeRig.add(leftEdge); edgeRig.add(rightEdge);

    const edgeState = { d: 3.0, margin: 0.5 };
    function positionEdgeAnchors(){
      const d = edgeState.d;
      const h = 2 * d * Math.tan(THREE.MathUtils.degToRad(camera.fov/2));
      const w = h * (innerWidth/innerHeight);
      leftEdge.position.set(-w/2 + edgeState.margin, -1.0, -d);
      rightEdge.position.set( w/2 - edgeState.margin, -1.0, -d);
      rightEdge.scale.x = Math.abs(rightEdge.scale.x) * -1;
    }
    positionEdgeAnchors();

    function setEdgeGrowth(t){
      const s = 0.25 + t*1.3;
      leftEdge.scale.set(s, s, s);
      rightEdge.scale.set(s, s, s);
      leftEdge.rotation.z = Math.sin(performance.now()*0.0012)*0.05*(0.2+t);
      rightEdge.rotation.z = -Math.sin(performance.now()*0.001)*0.05*(0.2+t);
    }

    // ---------- Scroll-driven growth + subtle camera parallax ----------
    let growth = 0, growthTarget = 0;
    function updateTarget(){
      const doc = document.documentElement;
      const max = (doc.scrollHeight - innerHeight) || 1;
      growthTarget = Math.min(1, Math.max(0, scrollY / max));
    }
    updateTarget();
    addEventListener('scroll', updateTarget, { passive: true });

    // ---------- Resize ----------
    addEventListener('resize', ()=>{
      renderer.setSize(innerWidth, innerHeight);
      camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix();
      composer.setSize(innerWidth, innerHeight);
      bloom.setSize(innerWidth, innerHeight);
      positionEdgeAnchors();
    });

    // ---------- Animate ----------
    const clock = new THREE.Clock();
    function animate(){
      requestAnimationFrame(animate);
      const dt = clock.getDelta();
      mixers.forEach(m=>m.update(dt));

      // lerp growth
      growth += (growthTarget - growth)*0.065;
      const ease = (t)=> t<.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2,3)/2;
      const g = ease(growth);

      // apply to plants
      for(const p of plants) setPlantGrowth(p, g);
      setEdgeGrowth(g);

      // parallax camera + light
      camera.position.x = Math.sin(g*2.4)*0.6;
      camera.position.y = 1.9 + g*0.5;
      camera.lookAt(0, 1.2, 0);
      sun.intensity = 1.0 + g*0.6;
      scene.fog.density = 0.035 - g*0.01;

      // fireflies drift
      const pos = fireflies.geometry.attributes.position;
      for(let i=0;i<fireflyCount;i++){
        let y = pos.getY(i) + (0.15 + speeds[i]*0.4)*dt;
        if(y>7.5) y = 0.4 + Math.random()*0.4;
        pos.setY(i, y);
        pos.setX(i, pos.getX(i) + Math.sin((i*0.37 + performance.now()*0.0007))*0.002);
        pos.setZ(i, pos.getZ(i) + Math.cos((i*0.29 + performance.now()*0.0006))*0.002);
      }
      pos.needsUpdate = true;

      // bloom pulses with growth
      bloom.strength = 0.55 + g*0.55;

      positionEdgeAnchors();
      composer.render();
    }
    animate();

    // ========== INTERACTION: 3D tilt / spring on gallery cards ==========
    const cards = [...document.querySelectorAll('[data-tilt]')];
    const state = new WeakMap();
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

    function pointer(e, el){
      const r = el.getBoundingClientRect();
      const x = (e.clientX ?? (e.touches?.[0]?.clientX||0)) - r.left;
      const y = (e.clientY ?? (e.touches?.[0]?.clientY||0)) - r.top;
      return { x, y, w:r.width, h:r.height };
    }

    function onMove(e){
      const el = e.currentTarget;
      const p = pointer(e, el);
      const nx = (p.x / p.w) * 2 - 1;   // -1..1
      const ny = (p.y / p.h) * 2 - 1;
      const depth = Number(el.dataset.depth || 16);
      const rx = clamp(-ny * (depth*0.5), -10, 10);
      const ry = clamp( nx * depth, -18, 18);
      const z = 8 + Math.hypot(nx, ny)*4;

      el.style.transform = `perspective(900px) rotateX(${rx}deg) rotateY(${ry}deg) translateZ(${z}px)`;
    }

    function onEnter(e){
      const el = e.currentTarget;
      el.style.transition = 'transform .2s cubic-bezier(.2,.8,.2,1), box-shadow .3s ease';
      el.style.transform = 'perspective(900px) rotateX(0deg) rotateY(0deg) translateZ(10px)';
      const img = el.querySelector('.toon-img');
      img.style.willChange = 'transform, filter';
    }

    function onLeave(e){
      const el = e.currentTarget;
      el.style.transition = 'transform .6s cubic-bezier(.2,.8,.2,1)';
      el.style.transform = 'perspective(900px) rotateX(0deg) rotateY(0deg) translateZ(0px)';
    }

    // gentle idle float
    function drift(){
      const t = performance.now()*0.0012;
      cards.forEach((el,i)=>{
        const k = 0.5 + i*0.13;
        el.style.filter = `drop-shadow(0 ${Math.sin(t+k)*4}px ${16+Math.cos(t*0.7+k)*6}px rgba(0,255,170,.12))`;
      });
      requestAnimationFrame(drift);
    }
    drift();

    cards.forEach(el=>{
      el.addEventListener('pointermove', onMove);
      el.addEventListener('pointerenter', onEnter);
      el.addEventListener('pointerleave', onLeave);
      el.addEventListener('touchmove', onMove, {passive:true});
    });
  </script>
</body>
</html>
